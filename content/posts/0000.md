---
title: "用Hugo+码云搭建支持Markdown+LaTeX的云笔记"
date: 2020-01-07T19:20:35+08:00
draft: true
categories: ["维护"]
tags: ["hugo","码云","typora","markdown","latex"]
---

## 目标

> 更新流程简单舒服，页面主题简洁，完全支持Markdown+LaTeX。

1）**本地撰写**内容：用[Typora](https://www.typora.io/)写基于Markdown+LaTeX的内容。

2）利用静态网站生成器Hugo生成待发布的静态文件： 执行`./forgitee`([下载](/notes/assets/forgitee))即可。

- 这个脚本实际依次执行了：1. 对所有md文件进行部分内容替换，确保站点可以完全解析；2. 执行`hugo -D`,生成待发布的静态文件，生成文件夹`public`; 3. 执行`fortypora`([下载](/notes/assets/fortypora))对所有md文件进行逆向置换复原，确保Typora打开能完全显示正常。

3） 将站点**git提交**到[码云（gitee）](https://gitee.com)： https://gitee.com/chaoskey/notes 

- 包括站点全部源码（相当于文档云同步）和生成的静态文件目录`public`。

4） 部署到： https://chaoskey.gitee.io/notes

![](../images/0103.jpg)

<!--more-->

## 第一步：安装git

我选择的是[官方winGUI版本](https://git-scm.com/)，国内很难下载，建议翻墙下载。默认选项安装即可。

由于官方版本本来就支持shell，后面的操作主要是在git bash下进行，如果GUI更方便时就使用GUI。

## 第二步：安装Hugo

选择Hugo的原因，是因为配置简单、库依赖度很低。

依然选择[官方win版本](https://github.com/gohugoio/hugo/releases)，翻墙下载。

我选择的是`hugo_extended_0.64.1_Windows-64bit.zip`，解压，设置好PATH就能用。

## 第三步：在码云上创建一个初始库

选择[码云](https://gitee.com/)而不是GitHub的原因是众所周知，虽然可以翻墙，毕竟麻烦。

创建一个初始库即可，不用额外设置。

我所创建的库是：[https://gitee.com/chaoskey/notes](https://gitee.com/chaoskey/notes)

## 第四步：建立初始站点

打开git bash，后同。

```shell
# 初始化本地站点
hugo new site notes
cd notes
```

打开git GUI, 将`https://gitee.com/chaoskey/notes`克隆到刚构建本地目录`notes`。 如果克隆时提示已存在，则先备份notes，克隆后再覆盖回去。

![](../images/0020.jpg)

先设置站点根目录  https://chaoskey.gitee.io/notes/

## 第五步：选择主题

我的目标是学习笔记，所以我找到一款简洁并适合的主题`hugo-book`：

```shell
# 克隆主题到themes/book
git clone https://github.com/alex-shpak/hugo-book themes/book

# 复制主题范例站点和配置
cp -a themes/book/exampleSite/config.toml .
cp -a themes/book/exampleSite/content .
```

## 第六步：公式引擎配置(可选)

由于该主题已经支持`katex`，所以此步可选。 但默认只支持`{{</* katex [display] */>}}latex{{</* /katex */>}}`格式，所以我作了后面的改动，以支持```$$\latex$$```的格式，并且还通过配置支持`katex`和`mathjax`。

下载`shortcodes`代码文件：[katex.html](/notes/assets/katex.html)。把这个文件放在当前主题对应路径下：

- `themes\<主题名>\layouts\shortcodes\katex.html`

或，放在站点对应路径下：

- `layouts\shortcodes\katex.html`

然后，在`config.toml`中添加一段配置，默认使用`katex`引擎

```latex
  #######################################
  # (Optional, default none) 选择数学公式渲染引擎
  # 默认就是katex引擎,  另外的选择就是 mathjax引擎 (即使改了引擎，标签也继续沿用katex)
  # 优先使用$$作为公式界定符号
  #  1. 内联公式，比如： $$a^2$$
  #  2. 块公式，比如：
  #     $$
  #     a^2
  #     $$
  # 如果渲染失败时（hugo和引擎的冲突），首先作如下2个置换 
  #  1. 内联公式:\$\$(.*?\\[\\\}\{].*?)\$\$ => {{</* katex */>}}$1{{</* /katex */>}}
  #  2. 块公式:\$\$(\n.*?\\[\\\}\{].*?\n)\$\$ => {{</* katex display */>}}$1{{</* /katex */>}}
  # 如果还是失败，则修改公式。
  #######################################
  # katex = "mathjax"
```

## 第七步：Typora和Hugo站点协调

由于Hugo的Markdown解析机制和```$$```格式下的公式又是存在冲突存在，导致能再Typora显示正常的公式，在Hugo解析Markdown时会错误显示或步显示公式。

为了解决这个问题，我写了两个shell脚本：`fortypora`([下载](/notes/assets/fortypora))和`forgitee`([下载](/notes/assets/forgitee))。

写文章时，先执行:

```shell
# 将`{{</* katex [display] */>}}latex{{</* /katex */>}}`
# 转换成$$格式
./fortypora
```

站点预览或站点发布时，执行:

```shell
# 先将`$$`
# 转换成`{{</* katex [display] */>}}latex{{</* /katex */>}}`
# 再执行 hugo [servere] -D 命令
# ./forgitee       # 站点发布（生成静态文件）
./forgitee server  # 站点预览

```


## 日常操作

1）用`typora`写文章

```shell
# 写文章前确保执行过下面的命令
./fortypora

# 构建新文章模板
hugo new docs/my-first-post.md 
```

2）预览站点 生成静态文件

```shell
# 站点预览
./forgitee server  

# 站点发布（生成静态文件）
./forgitee       
```

3）用`git`提交站点（包括站点源码和静态文件）

